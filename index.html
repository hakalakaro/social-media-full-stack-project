<!DOCTYPE html>
<html lang="en">

<head>
  <title>Test project</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Poppins:wght@700&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>

  <div class="header">
    <nav data-bs-theme="dark" style="justify-content: center;">
      <nav class="navbar navbar-expand-lg bg-body-tertiary"
        style="background-color: rgba(var(--bs-dark-rgb)); border-bottom: 2px solid #555555; padding: 10px;">
        <div class="container-fluid">
          <a class="navbar-brand" id="homeL" href="#" style="float: left;"><img src="./images/logopicture.jpg" id="logo"
              alt="Logo" style="height: 90px; margin-left: 25px; border-radius: 10px;"></a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0" style="font-size: 20px;">
              <li class="nav-item" style="padding-right: 40px;">
                <a class="nav-link active" aria-current="page" href="#" id="homeLink" style="margin-left: 45px;"><i
                    class="fa fa-home" aria-hidden="true" style="margin-right: 5px; color: #e58e26;;"></i>Home</a>
              </li>
              <li class="nav-item" style="padding-right: 40px;">
                <a class="nav-link" id="aboutLink" href="#" style="color: white;"><i class="fa fa-info-circle"
                    aria-hidden="true" style="margin-right: 5px; color: #e58e26;;"></i>About</a>
              </li>
              <li class="nav-item dropdown" style="padding-right: 40px;">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                  aria-expanded="false" style="color: white;"><i class="fas fa-cube" aria-hidden="true"
                    style="margin-right: 5px; color: #e58e26;;"></i>
                  Portal
                </a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#loginModal"
                      id="loginDropdown"><i class="fa fa-sign-in" aria-hidden="true"
                        style="margin-right: 14px;"></i>Login</a></li>
                  <li><a class="dropdown-item" href="#create-account" id="createAccDropdown"><i class="fa fa-user-plus"
                        aria-hidden="true" style="margin-right: 10px;"></i>Register</a></li>
                  <li><a class="dropdown-item" href="#" id="profileDropdown" style="display: none;"><i
                        class="fa fa-user" aria-hidden="true" style="margin-right: 15px;"></i>Profile</a></li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li><a class="dropdown-item" href="#" id="helpDropdown"><i class="fa fa-question-circle"
                        aria-hidden="true" style="margin-right: 14px;"></i>Help</a></li>
                  <li><a class="dropdown-item" href="#" id="logoutDropdown" style="display: none;"><i
                        class="fa fa-sign-out" aria-hidden="true" style="margin-right: 13px;"></i>Logout</a></li>
                </ul>
              </li>

            </ul>
            <form class="d-flex" role="search" id="searchForm" style="margin-left: 258px;">
              <div id="userAlerts" style="margin-right: 20px;">
                <i class="fa-solid fa-bell fa-2x" id="userAlertsIcon"
                  style="color: #aaaaaa; cursor: pointer; font-size: 30px; display: none;" title="Notifications"></i>
              </div>
              <!-- Dropdown with Font Awesome Icon -->
              <div class="dropdown">
                <i class="fa fa-cog fa-2x fa-sync fa-spin dropdown-toggle" id="dropdownMenuButton"
                  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                  style="margin-right: 20px; color: #aaaaaa; cursor: pointer; font-size: 30px;" title="Settings"></i>

                <!-- Dropdown Menu -->
                <div class="dropdown-menu" id="dropdown-menu2" aria-labelledby="dropdownMenuButton">
                  <a class="dropdown-item" id="settingsBtn" href="#"><i class="fa fa-cog" aria-hidden="true"
                      style="margin-right: 12px;"></i>Settings</a>
                  <hr class="dropdown-divider">
                  <a class="dropdown-item" id="nightModeToggle" href="#"><i class="fa fa-moon-o" id="nightModeIcon"
                      aria-hidden="true" style="margin-right: 10px;"></i>
                    <span id="nightModeText">Night Mode</span></a>
                </div>
              </div>

              <!-- Search Input Field -->
              <div id="searchBarToggle" style="display: none;">
                <input class="form-control me-2" id="searchInput" type="search" placeholder="Search users"
                  aria-label="Search" style="border-color: #555555;">

                <!-- Search Button -->
                <button class="btn btn-outline-secondary" type="submit" id="searchBtn"
                  style="background-color: rgba(var(--bs-dark-rgb)); color: white; border-color: #555555; margin-right: 25px;">
                  Search
                </button>
              </div>
            </form>
          </div>
        </div>
      </nav>
    </nav>
  </div>

  <div class="row">
    <div class="column side" id="side1">
      <div id="settingsContainer">
        <div id="settingsHeader">
          <h2 class="active-friends-header"><i class="fas fa-cog"
              style="margin-right: 10px; color: #e58e26;"></i>Settings</h2>
        </div>
        <div id="settingsContainerInner">

        </div>
      </div>
    </div>
    <!-- Middle div start -->
    <div class="column middle">
      <!-- Carousel -->
      <div id="carouselExampleCaptions" class="carousel slide">
        <div class="carousel-indicators">
          <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="0" class="active"
            aria-current="true" aria-label="Slide 1"></button>
          <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="1"
            aria-label="Slide 2"></button>
          <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="2"
            aria-label="Slide 3"></button>
        </div>
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img src="./images/testpicture1.jpg" class="d-block w-100" alt="...">
            <div class="carousel-caption d-none d-md-block">
              <h5>Connect</h5>
              <p>Interact with millions of people around the world.</p>
            </div>
          </div>
          <div class="carousel-item">
            <img src="./images/testpicture2.jpg" class="d-block w-100" alt="...">
            <div class="carousel-caption d-none d-md-block">
              <h5>Share</h5>
              <p>Share your stories and pictures.</p>
            </div>
          </div>
          <div class="carousel-item">
            <img src="./images/testpicture3.jpg" class="d-block w-100" alt="...">
            <div class="carousel-caption d-none d-md-block">
              <h5>Free to use</h5>
              <p>Creating your account is fast and simple.</p>
              <button type="button" class="like-button" id="registerBtn">Get
                Started</button>
            </div>
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleCaptions"
          data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleCaptions"
          data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
      <!-- Account Creation Form -->
      <div id="accountForm" style="display: none; padding: 17px; border-radius: 10px;">
        <h3>Register</h3>
        <form id="registerForm">
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" placeholder="Enter username">
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email address</label>
            <input type="email" class="form-control" id="email" placeholder="name@example.com">
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" placeholder="Password">
          </div>
          <button class="like-button" type="submit">Register</button>
        </form>
      </div>
      <!-- About Page -->
      <div id="aboutPage" style="display: none;">
        <div id="aboutPageContainer">
          <div id="aboutPageTitle">
            <h2 class="aboutPageHeader">
              <span class="white-text">About</span>
              <span class="white-text">This</span>
              <span class="orange-text">Project</span>
            </h2>
          </div>
        </div>
      </div>
      <!-- Main Page -->
      <div id="mainPage" style="display: none; background-color: #fafafa;">
        <div id="mainContainer" style="text-align: center; position: relative;">
          <div id="hoverTip" style="position: absolute; top: 0; left: 20px;">
            <i class="fa-solid fa-caret-down fa-3x"></i>
          </div>
          <!-- Text/Picture Switch -->
          <div class="switchHeader">
            <div class="btn-group" id="switchHeaderBtnGroup" role="group" aria-label="Basic example">
              <button type="button" class="btn switchHeaderBtn" style=" border: none; font-weight: 500;">
                <i class="far fa-images fa-1x" aria-hidden="true"
                  style="font-size: 20px; cursor: pointer; padding: 5px; color: #e58e26;" title="Show Images"></i>
                Images
              </button>
              <button type="button" class="btn switchHeaderBtn" style=" border: none; font-weight: 500;">
                <i class="fa fa-list-alt fa-1x" aria-hidden="true"
                  style="font-size: 20px; cursor: pointer; padding: 5px; color: #e58e26;" title="Show Stories"></i>
                Stories
              </button>
              <button type="button" class="btn switchHeaderBtn" id="cameraIcon1" style=" border: none; font-weight: 500;">
                <i id="cameraIcon" class="fa fa-upload fa-1x" aria-hidden="true"
                  style="font-size: 20px; cursor: pointer; padding: 5px; color: #e58e26;" title="Upload Images"></i>
                Share Images
              </button>
              <button type="button" class="btn switchHeaderBtn" id="keyboardIcon1" style=" border: none; font-weight: 500;">
                <i id="keyboardIcon" class="fa-solid fa-comment fa-1x" aria-hidden="true"
                  style="font-size: 20px; cursor: pointer; padding: 5px; color: #e58e26;" title="Upload Text"></i>
                Share Stories
              </button>
              <button type="button" id="toggleIcon" class="btn switchHeaderBtn" style=" border: none; font-weight: 500;">
                <i class="fa fa-arrows-v fa-1x" aria-hidden="true"
                  style="font-size: 20px; cursor: pointer; padding: 5px; color: #e58e26;" title="Show/Hide UI"></i>
                Toggle Interface
              </button>
            </div>
          </div>

          <p style="padding: 20px;">Error fetching posts from database.</p>

          <!-- Container for uploaded images -->
          <div class="uploaded-image-container">
            <div class="uploaded-image">
              <!-- The uploaded image will be dynamically inserted here -->
              <img id="uploadedImage" src="" alt="Uploaded Image"
                style="width: 100%; height: 100%; border-radius: 10px;" />
            </div>
          </div>


        </div>
        <!-- Text Container-->
        <div class="bg-dark" data-bs-theme="dark" id="textContainer"
          style=" border-top-left-radius: 5px; border-top-right-radius: 5px; display: none; ">
          <div style="display: flex; position: absolute; float: left; width: 100%; height: 80%; align-items: center;">
            <label for="exampleFormControlTextarea1" class="form-label" id="textShareText"
              style=" margin-top: 30px;">Share your <span id="span2">&nbsp;<em>stories</em></span></label>
            <textarea class="form-control" id="textBox" rows="3"
              style="height: 80%; width: 25%;  resize: none; margin-left: 50px; "></textarea>
            <button class="shareBtn " type="submit"
              style="margin-left: 50px; width: 140px; font-family: 'Poppins', sans-serif; "><i class="fa fa-pencil"
                aria-hidden="true" style="margin-right: 10px;"></i>Share</button>
          </div>
        </div>
        <!-- Upload Container-->
        <div class="bg-dark" data-bs-theme="dark" id="postContainer"
          style="  border-top-left-radius: 5px; border-top-right-radius: 5px; ">
          <div id="imageShareText" style="text-align: center; align-items: center; display: flex; margin-left: 150px; ">
            Share your <span id="span1">&nbsp;<em>images</em></span></div>
          <div id="imageUploadContainer" style="display: flex;">
            <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data"
              style="margin-left: 40px; display: flex; align-items: center; color: white;">
              <input type="file" name="image" accept=".jpg, .jpeg, .png" required />
              <button class="shareBtn " type="submit" style="width: 140px; font-family: 'Poppins', sans-serif;"><i
                  class="fa fa-upload" aria-hidden="true" style="margin-right: 10px;"></i> Share</button>
            </form>
          </div>
        </div>
      </div>
      <!-- Profile Page -->
      <div id="profilePage" style="display: none;">
        <div id="profilePageContainer">
          <div id="profilePageHeader">
            <div id="profilePictureContainer">
              <img id="profilePicture" src="" alt="Profile Picture"
                style=" width: 100%; height: 100%;  object-fit: cover;" />
              <i class='far fa-image' id="profilePicPlaceholder"
                style='font-size:75px; color: #969494; position: absolute; display: none;'></i>
            </div>
            <div id="profileUserInfo">
              <div id="welcomeProfileMessage">
                Welcome back, <span id="welcomeProfileUser" style="margin-left: 20px;">&nbsp;User.</span>
              </div>
            </div>
            <div id="profileSettings">

            </div>
            <div id="profileSettings2">
              <div class="settings-section">
                <span class="settings-text">Change profile picture</span>
                <div class="settings-control">
                  <input type="file" id="uploadProfileInput" style="display: none;" accept=".jpg, .jpeg, .png"
                    onchange="uploadProfilePicture(event)" />
                  <button class="settings-button like-button" onclick="document.getElementById('uploadProfileInput').click()">Browse</button>
                </div>
              </div>

              <div class="settings-section">
                <span class="settings-text">Change password</span>
                <div class="settings-control">
                  <input type="password" id="passwordChangeField1" placeholder="New password.." />
                  <input type="password" id="passwordChangeField2" placeholder="New password.." />
                  <button class="settings-button like-button">Confirm</button>
                </div>
              </div>

              <div class="settings-section">
                <span class="settings-text">Delete account</span>
                <div class="settings-control">
                  <button class="settings-button like-button">Confirm</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Help Page -->
      <div id="helpPage" style="display: none;">
        <div id="helpPageContainer">

        </div>
      </div>
    </div>
    <div class="column side" id="side2">
      <div id="searchResults"></div>
      <div id="userAlertsContainer">
        <div id="userAlertsContainerHeader">
          <span id="userAlertsContainerText"><i class="fa-solid fa-bell"
              style="margin-right: 10px; color: #e58e26;"></i>Notifications</span>
        </div>
        <div id="userAlertsContent">

        </div>
      </div>
      <div class="friendsListModal" id="friendsListModal" style="display: none;">
        <h2 class="active-friends-header"><i class="fas fa-user-friends"
            style="margin-right: 10px; color: #e58e26;"></i>Friends
        </h2>
        <div class="friendsListModalContainer" id="friendsListModalContainer">

        </div>
      </div>
      <i class='fas fa-user-friends' id="friendsListIcon" title="Friend List" style="display: none;"></i>
    </div>
  </div>

  <div class="footer" data-bs-theme="dark">
    <p id="footerText">Garbagebook</p>

  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true"
    style="border-radius: 15px;">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background-color: rgba(var(--bs-dark-rgb)); color: rgb(211, 211, 211);  ">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel" style="text-align: center; width: 100%; margin-left: 20px;">Login
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
            style="background-color: white;"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="loginUsername" class="form-label">Username</label>
              <input type="text" class="form-control" id="loginUsername" placeholder="Enter username">
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">Password</label>
              <input type="password" class="form-control" id="loginPassword" placeholder="Password">
            </div>
            <button class="btn btn-outline-secondary" type="submit"
              style=" background-color: rgba(var(--bs-dark-rgb)); color: rgb(211, 211, 211); border-color: #555555; ">Login</button>
            <div id="loginMessage" style="margin-top: 10px;"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
  </div>
  <script>
    
    document.addEventListener("DOMContentLoaded", function () {
      // Check login state and update visibility on load
      updateLogoutLinkVisibility();

      // Show login modal on page load if not logged in
      if (!isLoggedIn()) {
        $('#loginModal').modal('show'); // Show the login modal if not logged in
        const dropdownMenuButton = document.getElementById('dropdownMenuButton');
        const dropdownMenu2 = document.querySelector('#dropdown-menu2');
        dropdownMenuButton.style.setProperty('margin-left', '-100px', 'important'); // Move cog icon to the left
        dropdownMenu2.style.setProperty('transform', 'translateX(-150px)', 'important');

      }

      function handleHomeNavigation() {
        if (!isLoggedIn()) {
          document.getElementById("carouselExampleCaptions").style.display = "block"; // Show carousel if logged out
          document.getElementById("mainPage").style.display = "none"; // Hide main page
          document.getElementById("accountForm").style.display = "none";
          document.getElementById("helpPage").style.display = "none";
          document.getElementById("profilePage").style.display = "none";
          aboutPage.style.display = 'none';
          aboutPageContainer.style.display = 'none';
        } else {
          document.getElementById("carouselExampleCaptions").style.display = "none"; // Hide carousel if logged in
          document.getElementById("mainPage").style.display = "block"; // Show main page content
          document.getElementById("helpPage").style.display = "none";
          document.getElementById("profilePage").style.display = "none";
          aboutPage.style.display = 'none';
          aboutPageContainer.style.display = 'none';
        }
      }
      document.getElementById('homeL').addEventListener('click', () => {
        mainContainer.scrollTo({ top: 0, behavior: 'smooth' });
      });
      // Set up the click event for homeLink
      document.getElementById("homeLink").onclick = handleHomeNavigation;
      document.getElementById('homeLink').addEventListener('click', () => {
        const mainContainer = document.getElementById('mainContainer');
        mainContainer.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to the top
      });
      // Set up the click event for homeLogo
      document.getElementById("logo").onclick = handleHomeNavigation; // Add similar functionality
      // Event listener for the account creation link
      document.querySelector(".dropdown-item[href='#create-account']").addEventListener("click", function (e) {
        e.preventDefault();
        helpPage.style.display = 'none';
        showAccountForm(); // Call the function to show account form
      });

      // Event listener for the login button
      const registerBtn = document.getElementById("registerBtn");
      if (registerBtn) {
        registerBtn.addEventListener("click", showAccountForm); // Added here for clarity
      }

      // Add event listener for the register form submission
      document.getElementById('registerForm').addEventListener('submit', async function (event) {
        event.preventDefault(); // Prevent the default form submission

        // Collect form data
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        // Create the user object to send to the server
        const userData = {
          username: username,
          email: email,
          password: password,
        };

        try {
          const response = await fetch('http://localhost:5000/auth/register', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData),
          });

          if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
            alert('There was a problem registering your user.')
          }

          const data = await response.json();
          console.log('User registered:', data);
          alert('User registered successfully.')
          // Optionally, redirect or show a success message
        } catch (error) {
          console.error('There was a problem with the fetch operation:', error);
        }
      });

      // Add event listener for the login form submission
      document.getElementById('loginForm').addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent default form submission

        // Get form input values
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const mainContainer = document.getElementById('mainContainer');
        try {
          const response = await fetch('http://localhost:5000/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });

          if (response.ok) {
            const data = await response.json();
            console.log("Login successful", data);
            mainContainer?.scrollTo({ top: 0, behavior: 'smooth' });
            localStorage.setItem("authToken", data.token); // Store token
            localStorage.setItem("username", username); // Store username
            loadFriendsList();
            updateLogoutLinkVisibility(); // Update logout link visibility
            fetchFriendRequests();
            $('#loginModal').modal('hide'); // Hide the modal
            document.getElementById('welcomeProfileUser').textContent = username;
            if (data.profilePicture) {
              localStorage.setItem("profilePicture", data.profilePicture);
            } else {
              localStorage.removeItem("profilePicture"); // Clear if not set
            }

            displayProfilePicture();
            location.reload();
          } else {
            console.error("Login failed");
            // Handle login failure, e.g., display an error message to the user
          }
        } catch (error) {
          console.error("Error:", error);
        }
      });
    });

    function isLoggedIn() {
      return !!localStorage.getItem("authToken"); // Returns true if the token exists
    }

    function updateLogoutLinkVisibility() {
      const createAccLink = document.getElementById("createAccDropdown");
      const logoutLink = document.getElementById("logoutDropdown");
      const loginLink = document.getElementById("loginDropdown");
      const profileLink = document.getElementById("profileDropdown");
      const friendsListIcon = document.getElementById("friendsListIcon");

      if (isLoggedIn()) {
        userAlertsIcon.style.display = "flex";
        searchBarToggle.style.display = "flex";
        logoutLink.style.display = "block"; // Show the Logout link
        loginLink.style.display = "none";
        profileLink.style.display = "block";
        createAccLink.style.display = "none";
        friendsListIcon.style.display = "block";
        document.getElementById("accountForm").style.display = "none"; // Hide account form
        document.getElementById("carouselExampleCaptions").style.display = "none"; // Hide carousel
        document.getElementById("mainPage").style.display = "block"; // Show main page content
      } else {
        userAlertsIcon.style.display = "none";
        logoutLink.style.display = "none"; // Hide the Logout link
        createAccLink.style.display = "block"; // Show account creation link
        loginLink.style.display = "block"; // Show login link
        profileLink.style.display = "none"; // Hide profile link
        friendsListIcon.style.display = "none";
        document.getElementById("accountForm").style.display = "none"; // Hide account form when logged out
        document.getElementById("mainPage").style.display = "none"; // Hide main content when logged out
      }
    }

    function handleRegisterBtnClick() {
      // Hide the carousel and the account creation form
      document.getElementById("carouselExampleCaptions").style.display = "none";
      document.getElementById("accountForm").style.display = "none";

    }

    function logout() {
      localStorage.removeItem('authToken');
      alert('Logged out successfully');
      // Hide the main content area
      document.getElementById('mainPage').style.display = 'none';
      // Hide the profile page
      document.getElementById('profilePage').style.display = 'none';
      // Show the carousel
      document.getElementById('carouselExampleCaptions').style.display = 'block';
      document.getElementById('helpPage').style.display = 'none';
      document.getElementById('friendsListModal').style.display = 'none';
      searchBarToggle.style.display = "none";
      userAlertsIcon.style.display = "none";
      const dropdownMenuButton = document.getElementById('dropdownMenuButton');
      const dropdownMenu2 = document.querySelector('#dropdown-menu2');
      dropdownMenuButton.style.setProperty('margin-left', '-100px', 'important'); // Move cog icon to the left
      dropdownMenu2.style.setProperty('transform', 'translateX(-150px)', 'important');
      // Hide the chat modal
    const chatModal = document.getElementById('chatModal');
    if (chatModal) {
        chatModal.style.display = 'none';
    }
    
    // Reset chat state
    currentChatPartner = null;
    
    // Disconnect socket if it exists
    if (socket) {
        socket.disconnect();
        socket = null;
    }

      // Update logout link visibility
      updateLogoutLinkVisibility();
    }

    // Add logout functionality to the logout link
    document.addEventListener("DOMContentLoaded", function () {
      const logoutLink = document.getElementById("logoutDropdown");
      if (logoutLink) {
        logoutLink.addEventListener("click", function (e) {
          e.preventDefault(); // Prevent default link behavior
          localStorage.removeItem('authToken');
          logout(); // Call the logout function
        });
      }
    });

    function showAccountForm() {
      // Hide the carousel and show the account creation form
      document.getElementById('carouselExampleCaptions').style.display = 'none';
      document.getElementById('accountForm').style.display = 'block';
      document.getElementById('helpForm').style.display = 'none';
    }

    document.getElementById('uploadForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      console.log('Upload form submitted'); // Debug log

      const fileInput = document.querySelector('input[name="image"]');
      const formData = new FormData(event.target);
      const token = localStorage.getItem("authToken");

      console.log('File selected:', fileInput.files[0]); // Debug log
      console.log('Token:', token); // Debug log

      try {
        const response = await fetch('http://localhost:5000/upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
          body: formData,
        });

        console.log('Upload response:', response); // Debug log

        if (!response.ok) {
          console.error("Server responded with an error:", await response.text());
          return;
        }

        const data = await response.json();
        console.log('Upload success:', data);  // Debug log

        // Add delay before calling loadImages
        setTimeout(async () => {
          await loadImages();
        }, 2000);

      } catch (error) {
        console.error('Error uploading image:', error);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      const keyboardIcon = document.getElementById("keyboardIcon");
      const uploadIcon = document.getElementById("uploadIcon");
      const postContainer = document.getElementById("postContainer");
      const textContainer = document.getElementById("textContainer");
      const mainContainer = document.getElementById('mainContainer');

      // Add click event listener to the keyboard icon
      keyboardIcon1.addEventListener("click", function () {
        // Hide the keyboard icon and show the upload icon
        if (textContainer.style.display === 'none') {
          // Show/Hide text/upload containers
          postContainer.style.display = "none";
          textContainer.style.display = "block";
          textContainer.style.display = "flex";
          textContainer.style.backgroundColor = "rgba(var(--bs-dark-rgb))";
          textContainer.style.height = "18vh";
          textContainer.style.boxShadow = "rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;"
          textContainer.style.borderbottomleftradius = "0";
          textContainer.style.borderbottomrightradius = "0";
          mainContainer.style.height = '65vh';
        }
        else {
          textContainer.style.display = 'none';
          mainContainer.style.height = '85vh';
        }
      });

      cameraIcon1.addEventListener("click", function () {
        if (postContainer.style.display === 'none') {
          postContainer.style.display = "block";
          textContainer.style.display = "none";
          postContainer.style.display = "flex";
          postContainer.style.backgroundColor = "rgba(var(--bs-dark-rgb))";
          postContainer.style.height = "18vh";
          postContainer.style.display = "flex";
          postContainer.style.boxShadow = "rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;"
          postContainer.style.borderbottomleftradius = "0";
          postContainer.style.borderbottomrightradius = "0";
          mainContainer.style.height = '65vh';
        }
        else {
          postContainer.style.display = 'none';
          mainContainer.style.height = '85vh';
        }

      });
    });

    //Load images from database and create layout for pictures/comments etc
    async function loadImages() {
      try {
        const token = localStorage.getItem('authToken');
        console.log('Token:', token);

        // Get current username from token
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const decodedToken = JSON.parse(atob(base64));
        const currentUsername = decodedToken.username;

        // First, fetch the user's friends list
        const friendsResponse = await fetch('http://localhost:5000/users/friends', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!friendsResponse.ok) {
          throw new Error('Failed to fetch friends list');
        }

        const friends = await friendsResponse.json();
        // Create a Set of friend usernames for faster lookup
        const friendUsernames = new Set(friends.map(friend => friend.username));

        // Then fetch all posts
        const response = await fetch('http://localhost:5000/upload/images', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`Network response was not ok: ${response.statusText}`);
        }

        const data = await response.json();
        const postContainer = document.getElementById('mainContainer');
        console.log('Fetched data:', data);

        // Remove any existing <p> element if present
        const pElement = postContainer.querySelector('p');
        if (pElement) {
          pElement.remove();
        }

        // Remove all existing image containers to avoid duplicates
        postContainer.querySelectorAll('.uploaded-image-container').forEach(container => {
          container.remove();
        });

        // Filter posts to show both friends' posts AND your own posts
        const relevantPosts = data.filter(post => 
          friendUsernames.has(post.username) || // Posts from friends
          post.username === currentUsername      // Your own posts
        );

        if (relevantPosts.length === 0) {
          const noPostsMessage = document.createElement('p');
          noPostsMessage.style.padding = "20px";
          noPostsMessage.textContent = "No posts to display. Add some friends or create a post!";
          postContainer.appendChild(noPostsMessage);
          return;
        }

        // Add each image from the filtered data
        relevantPosts.reverse().forEach(post => {
          const { _id, imageUrl, username, comments, likes } = post;
          //console.log(`Post ID: ${post._id}, Likes: ${post.likes.length}`);
          //console.log('Post ID:', _id);
          //console.log('Comments:', comments);

          const displayUsername = post.username || 'Anonymous'; // Display "anonymous" if username not found.

          // Create the upper container for upload name of uploader etc
          const upperContainer = document.createElement('div');
          upperContainer.classList.add('uploaded-image-container', 'no-lines', 'upperContainer');
          upperContainer.innerHTML = `<span id="submittedBySpan"><i class="fa-solid fa-camera"></i> ${displayUsername}</span>`; // Example content

          // Create the container for each image
          const container = document.createElement('div');
          container.classList.add('uploaded-image-container', 'with-lines'); // Apply the container styles
          container.style.padding = "20px"; // Padding to add space around the image
          postContainer.appendChild(upperContainer);
          const img = document.createElement('img');
          img.src = `http://localhost:5000/${post.imageUrl}`;
          //console.log('Image URL:', img.src);  // Log image URL to verify it's correct
          img.alt = "Uploaded Image";
          img.classList.add('uploaded-image'); // Apply the existing image styles

          // Hide image if it fails to load
          img.onerror = () => {
            img.style.display = 'none';
          };

          // Add event listener for image click (optional: for enlarging)
          img.addEventListener('click', () => {
            img.classList.toggle('enlarged');
          });

          // Append the image to the container
          container.appendChild(img);
          // Append the container to the postContainer
          postContainer.appendChild(container);

          const newContainer = document.createElement('div');
          newContainer.classList.add('uploaded-image-container', 'no-lines');
          newContainer.Id = 'newContainer';
          newContainer.style.padding = '10px'; // Adjust padding if needed

          newContainer.style.marginBottom = '30px';
          newContainer.style.backgroundColor = '#fafafa';

          const button = document.createElement('button');
          const button2 = document.createElement('button');
          const button3 = document.createElement('button');

          button.classList.add('like-button'); // Add custom class for styling if needed
          button.id = `like-button-${_id}`;
          button2.classList.add('like-button');
          button3.classList.add('like-button', 'postComment');

          const icon = document.createElement('i');
          const icon2 = document.createElement('i');
          const icon3 = document.createElement('i');

          icon.classList.add('fa', 'fa-thumbs-up'); // Font Awesome thumbs-up icon
          icon2.classList.add('fa', 'fa-comment');
          icon3.classList.add('fa', 'fa-share');

          icon.setAttribute('aria-hidden', 'true'); // Accessibility
          icon2.setAttribute('aria-hidden', 'true');
          icon3.setAttribute('aria-hidden', 'true');

          // Add the icon inside the button
          button.appendChild(icon);
          button2.appendChild(icon2);
          button3.appendChild(icon3);

          // Set the button text 
          button.appendChild(document.createTextNode(` Like (${likes.length})`));
          button2.appendChild(document.createTextNode(` Comments (${comments.length})`));
          button3.appendChild(document.createTextNode(' Comment'));

          // Append the button to the newContainer
          newContainer.appendChild(button);
          newContainer.appendChild(button2);

          const commentBox = document.createElement('div');
          commentBox.classList.add('comment-box');  // Apply the CSS class for styling
          commentBox.style.display = 'none'; // Hide initially

          const inputField = document.createElement('input');
          inputField.type = 'text';
          inputField.placeholder = 'Write your comment...';
          inputField.classList.add('comment-input'); // Add a class for specific styling if needed

          commentBox.appendChild(inputField); // Append input field to comment box
          commentBox.appendChild(button3);

          button.addEventListener('click', async () => {
            const token = localStorage.getItem('authToken');
            const postId = _id; // Use the image ID from the current post

            try {
              const response = await fetch('http://localhost:5000/upload/like', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ postId })
              });
              if (!response.ok) {
                const errorData = await response.json();
                console.error('Error toggling like:', errorData);
                return;
              }

              const result = await response.json();  // Parse as JSON directly
              const likeText = ` Like (${result.likes})`;  // This is just the text part

              // Update only the text content while preserving the icon
              button.lastChild.textContent = likeText;

            } catch (error) {
              console.error('Error:', error);
            }
          });

          // Add event listener to comment button
          button2.addEventListener('click', () => {
            // Toggle visibility of the comment box when the comment button is clicked
            if (commentBox.style.display === 'none') {
              commentBox.style.display = 'block';
              inputField.focus(); // Auto-focus the input when opened
            } else {
              commentBox.style.display = 'none'; // Hide it again if it's already visible
            }
          });

          button3.addEventListener('click', async () => {
            const commentText = inputField.value.trim();
            if (!commentText) {
              alert('Please enter a comment before submitting.');
              return;
            }

            const token = localStorage.getItem('authToken');
            const postId = _id; // Use the image ID from the current post

            try {
              const response = await fetch('http://localhost:5000/upload/comment', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ postId, commentText })
              });

              if (response.ok) {
                inputField.value = ''; // Clear the input field on success
                alert('Comment added successfully!');

                // Add the new comment to the commentsContainer
                const newComment = document.createElement('div');
                newComment.classList.add('comment');
                commentDiv.innerHTML = `<span class="username">${comment.username}:</span> <br> <span class="userComment">${comment.commentText}</span>`;
                commentsContainer.appendChild(newComment);
                button2.textContent = ` Comments (${comments.length + 1})`;  // Update button text with new comment count
              } else {
                const errorData = await response.json();
                console.error('Error adding comment:', errorData);
              }
            } catch (error) {
              console.error('Error:', error);
            }
          });

          // Append the new container directly after the image container
          postContainer.appendChild(newContainer);
          newContainer.appendChild(commentBox);
          // Create a container for comments (if there are any)
          const commentsContainer = document.createElement('div');
          commentsContainer.classList.add('comments-container');
          commentsContainer.style.marginTop = '20px';

          // Display any existing comments
          comments.forEach(comment => {
            const commentDiv = document.createElement('div');
            commentDiv.classList.add('comment');
            commentDiv.innerHTML = `<span class="username">${comment.username}</span> <br> <span class="userComment">${comment.commentText}</span>`;
            commentsContainer.appendChild(commentDiv);
          });

          // Append the comments container to the commentBox
          commentBox.appendChild(commentsContainer);
        });

        // Keep fa icons positioned at the bottom

      } catch (error) {
        console.error('Error fetching images:', error);
        const postContainer = document.getElementById('mainContainer');
        postContainer.innerHTML = '<p style="padding: 20px;">Error loading posts. Please try again later.</p>';
      }

      mainContainer.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Run loadImages on window load
    window.onload = loadImages;



    // Toggle profile page
    document.getElementById('profileDropdown').addEventListener('click', function () {
      var profilePage = document.getElementById('profilePage');
      var mainPage = document.getElementById('mainPage');
      var helpPage = document.getElementById('helpPage');

      profilePage.style.display = 'block';
      mainPage.style.display = 'none';
      helpPage.style.display = 'none';
      aboutPage.style.display = 'none';
      aboutPageContainer.style.display = 'none';
    });

    // Toggle help page
    document.getElementById('helpDropdown').addEventListener('click', function () {
      var profilePage = document.getElementById('profilePage');
      var mainPage = document.getElementById('mainPage');
      var helpPage = document.getElementById('helpPage');
      var carouselExampleCaptions = document.getElementById('carouselExampleCaptions');
      var accountForm = document.getElementById('accountForm');

      aboutPage.style.display = 'none';
      aboutPageContainer.style.display = 'none';
      accountForm.style.display = 'none';
      carouselExampleCaptions.style.display = 'none';
      profilePage.style.display = 'none';
      mainPage.style.display = 'none';
      helpPage.style.display = 'block';
    });

    // Toggle Account Creation Form
    document.getElementById('createAccDropdown').addEventListener('click', function () {
      var helpPage = document.getElementById('helpPage');
      aboutPage.style.display = 'none';
      aboutPageContainer.style.display = 'none';
      helpPage.style.display = 'none';
    });
    // Custom script for the second dropdown (settings icon)
    document.querySelector('#dropdownMenuButton').addEventListener('click', function (event) {
      event.stopPropagation(); // Prevents closing the dropdown when clicking inside
      const dropdownMenu = this.nextElementSibling; // Get the corresponding dropdown menu
      dropdownMenu.classList.toggle('show'); // Toggle dropdown visibility
    });

    // Close the dropdown when clicking outside
    document.addEventListener('click', function (event) {
      const dropdownMenu = document.querySelector('.dropdown-menu');
      if (dropdownMenu && !dropdownMenu.contains(event.target) && !event.target.closest('.dropdown')) {
        dropdownMenu.classList.remove('show'); // Hide the dropdown if clicking outside
      }
    });

    // Close the dropdown2 when clicking outside
    document.addEventListener('click', function (event) {
      const dropdownMenu2 = document.querySelector('#dropdown-menu2');
      if (dropdownMenu2 && !dropdownMenu2.contains(event.target) && !event.target.closest('.dropdown')) {
        dropdownMenu2.classList.remove('show'); // Hide the dropdown if clicking outside
      }
    });

    // Toggle visibility of upload / post interface
    const toggleIcon = document.getElementById('toggleIcon');
    const mainContainer = document.getElementById('mainContainer');
    const textContainer = document.getElementById('textContainer');
    const postContainer = document.getElementById('postContainer');

    toggleIcon.addEventListener('click', () => {
      // Check if the textContainer is currently hidden
      if (textContainer.style.display && postContainer.style.display === 'none' || textContainer.style.display && postContainer.style.display === '') {
        // Show the textContainer and postContainer
        textContainer.style.display = 'none';
        postContainer.style.display = 'block';
        postContainer.style.backgroundColor = "rgba(var(--bs-dark-rgb))";
        postContainer.style.height = "18vh";
        postContainer.style.display = "flex";
        postContainer.style.boxShadow = "rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;"
        postContainer.style.borderbottomleftradius = "0";
        postContainer.style.borderbottomrightradius = "0";
        mainContainer.style.height = '65vh'; // Reset to original height
        postContainer.style.borderbottom = '2px solid #555555;'
      } else {
        // Hide the textContainer and postContainer
        textContainer.style.display = 'none';
        postContainer.style.display = 'none';
        mainContainer.style.height = '85vh'; // Adjust height as needed
      }
    });
    // Friend List icon event handler
    friendsListIcon.addEventListener('click', () => {
      const friendsListModal = document.getElementById('friendsListModal');
      if (friendsListModal.style.display === 'none') {
        friendsListModal.style.display = 'block';
      }
      else {
        friendsListModal.style.display = 'none';
      }
    });

    // Nightmode toggle
    const nightModeIcon = document.getElementById('nightModeIcon');
    const nightModeText = document.getElementById('nightModeText');

    nightModeToggle.addEventListener('click', () => {
      event.preventDefault();
      document.body.classList.toggle('night-mode');

      if (nightModeText.textContent === 'Night Mode') {
        nightModeText.textContent = 'Day Mode';
        nightModeIcon.classList.remove('fa-moon-o');
        nightModeIcon.classList.add('fa-sun-o');
        document.body.classList.add('night-mode'); // Add a class to enable dark mode
      } else {
        nightModeText.textContent = 'Night Mode';
        nightModeIcon.classList.remove('fa-sun-o');
        nightModeIcon.classList.add('fa-moon-o');
        document.body.classList.remove('night-mode'); // Remove the class to disable dark mode
      }
      // Save the preferred theme
      if (document.body.classList.contains('night-mode')) {
        localStorage.setItem('theme', 'night');
      } else {
        localStorage.setItem('theme', 'day');
      }

    });
    // Load preferred theme
    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'night') {
        document.body.classList.add('night-mode');
        nightModeText.textContent = 'Day Mode';
      }
    });
    // Settings on click event listener (fa cog)
    const settingsContainer = document.getElementById('settingsContainer');
    document.getElementById('settingsBtn').addEventListener('click', () => {
      if (settingsContainer.style.display === '' || settingsContainer.style.display === 'none') {
        settingsContainer.style.display = 'block';
      } else {
        settingsContainer.style.display = 'none';
      }
    });
    // About page click event listener
    const aboutPage = document.getElementById('aboutPage');
    const aboutPageContainer = document.getElementById('aboutPageContainer');

    document.getElementById('aboutLink').addEventListener('click', () => {
      mainPage.style.display = 'none';
      aboutPage.style.display = 'block';
      aboutPageContainer.style.display = 'block';
      profilePage.style.display = 'none';
      helpPage.style.display = 'none';
      accountForm.style.display = 'none';
      carouselExampleCaptions.style.display = 'none';
    });
    document.addEventListener('DOMContentLoaded', () => {
      const searchBtn = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      const searchResultsDiv = document.getElementById('searchResults');

      console.log('searchBtn:', searchBtn);
      console.log('searchInput:', searchInput);
      console.log('searchResultsDiv:', searchResultsDiv);

      // Add event listener for the search button
      searchBtn.addEventListener('click', async (event) => {
        event.preventDefault();  // Prevent the default form submission (page refresh)

        console.log('Button clicked');
        const query = searchInput.value.trim(); // Get the trimmed value from the input field
        console.log('Search query:', query);

        if (query === '') {
          searchResultsDiv.style.display = 'none'; // Hide the div if query is empty
          console.log('Query is empty, hiding results div');
          return;
        }

        searchResultsDiv.style.display = 'block'; // Show the div
        console.log('Displaying search results div');

        // Fetch users from the backend based on the search query
        try {
          const response = await fetch(`http://localhost:5000/users/search?query=${query}`);
          const users = await response.json(); // Parse the JSON response

          if (users.length > 0) {
            // Display the search results dynamically
            searchResultsDiv.innerHTML = `<p>Showing results for: "${query}"</p><ul>`;
            users.forEach(user => {
              searchResultsDiv.innerHTML += `
                    <li style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="margin-left: 10px;">${user.username}</span>
                        <button 
                            style=" border-radius: 5px;" 
                            id="friendBtn" 
                            onclick="sendFriendRequest('${user.username}')">
                            <i class="fas fa-user-plus"></i> 
                        </button>
                    </li>`;
            });
            searchResultsDiv.innerHTML += `</ul>`;
          } else {
            searchResultsDiv.innerHTML = `<p>No users found for "${query}"</p>`;
          }
        } catch (error) {
          console.error('Error fetching search results:', error);
          searchResultsDiv.innerHTML = `<p>There was an error fetching the search results.</p>`;
        }
      });
      document.addEventListener('click', (event) => {
        // Check if the click is outside the search results div
        if (!searchResultsDiv.contains(event.target) && !searchInput.contains(event.target) && event.target !== searchBtn) {
          searchResultsDiv.style.display = 'none';
          searchInput.value = '';
        }
      });
    });

    // Function to handle sending friend requests

    const userAlertsIcon = document.getElementById('userAlertsIcon');
    const userAlertsContainer = document.getElementById('userAlertsContainer');
    userAlertsIcon.addEventListener('click', () => {
      event.stopPropagation();
      if (userAlertsContainer.style.display === 'none') {
        userAlertsContainer.style.display = 'block';
      }
      else {
        userAlertsContainer.style.display = 'none';
      }
    });

    document.addEventListener('click', function (event) {
      const target = event.target;
      const settingsBtn = document.getElementById('settingsBtn');
      // Check if the click is outside the userAlertsContainer and userAlertsIcon
      if (!userAlertsContainer.contains(target) && target !== userAlertsIcon) {
        userAlertsContainer.style.display = 'none';
      }
      if (!settingsContainer.contains(target) && target !== settingsBtn) {
        settingsContainer.style.display = 'none';
      }
    });

    async function sendFriendRequest(username) {
      console.log(`Sending friend request to ${username}`);
      try {
        const token = localStorage.getItem('authToken');
        if (!token) {
          alert('Authentication token is missing');
          console.log('Token not found in localStorage');
          return;
        }
        const response = await fetch('http://localhost:5000/users/send-friend-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (response.ok) {
          alert('Friend request sent!');
        } else {
          alert(result.message);
        }
      } catch (error) {
        console.error('Error sending friend request:', error);
        alert('Failed to send friend request.');
      }
    }

    async function fetchFriendRequests() {
      const token = localStorage.getItem('authToken');
      console.log('Token from localStorage:', token); // Log token value
      if (!token) {
        console.log('No token found, aborting request');
        return;
      }
      try {
        const response = await fetch('http://localhost:5000/users/friend-requests', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // Check the response status and body
        if (!response.ok) {
          console.log('Failed to fetch friend requests', response.status, await response.text());
          return;
        }

        const { receivedRequests } = await response.json();

        // Log to check if receivedRequests is correct
        console.log('Received Friend Requests:', receivedRequests);

        const userAlertsContent = document.getElementById('userAlertsContent');
        userAlertsContent.innerHTML = '';

        const userAlertsIcon = document.getElementById('userAlertsIcon');


        if (receivedRequests.length > 0) {
          userAlertsIcon.classList.add('fa-beat', 'orange-alert');
          receivedRequests.forEach(username => {
            const requestDiv = document.createElement('div');
            requestDiv.id = 'requestDiv';
            requestDiv.innerHTML = `
                    <span style="font-weight: 500;">Friend request from: </span>
                    <span style="font-weight: 500;">${username}</span>
                    <button id="acceptFriendBtn" class="like-button" style="padding: 5px 5px;" onclick="acceptFriendRequest('${username}')">Accept</button>
                `;
            userAlertsContent.appendChild(requestDiv);
          });
        } else {
          userAlertsIcon.classList.remove('fa-beat', 'orange-alert');
          userAlertsContent.innerHTML = '<p style="color: #EDEDED; text-align: center; margin-top: 10px;">No notifications to display.</p>';
        }
      } catch (error) {
        console.error('Error fetching friend requests:', error);
      }
    }

    document.getElementById('userAlertsIcon').addEventListener('click', fetchFriendRequests);

    async function acceptFriendRequest(username) {
      console.log(`Accepting friend request from ${username}`);
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch('http://localhost:5000/users/accept-friend-request', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ username })
        });

        const result = await response.json();
        if (response.ok) {
          alert('Friend request accepted!');
          fetchFriendRequests(); // Refresh the list
        } else {
          alert(result.message);
        }
      } catch (error) {
        console.error('Error accepting friend request:', error);
        alert('Failed to accept friend request.');
      }
    }

    async function uploadProfilePicture(event) {
      const fileInput = event.target;
      const file = fileInput.files[0];
      if (!file) return;

      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
      if (!allowedTypes.includes(file.type)) {
        alert('Only JPG, JPEG, and PNG files are allowed.');
        return;
      }

      const formData = new FormData();
      formData.append('profilePicture', file);

      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('You are not logged in.');
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/users/upload-profile-picture', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          // Update profile picture on the frontend
          const profilePictureElement = document.getElementById('profilePicture');
          profilePictureElement.src = `http://localhost:5000${result.filePath}`;

          alert('Profile picture uploaded successfully!');
        } else {
          alert(result.message);
        }
      } catch (error) {
        console.error('Error uploading profile picture:', error);
        alert('Failed to upload profile picture.');
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      const username = localStorage.getItem('username');
      if (username) {
        document.getElementById('welcomeProfileUser').textContent = username;
      }
    });

    function displayProfilePicture() {
      console.log('displayProfilePicture called');

      const profilePictureUrl = localStorage.getItem('profilePicture');
      console.log('Profile Picture URL from localStorage:', profilePictureUrl);

      const profileImageElement = document.getElementById('profilePicture');

      if (profileImageElement) {
        if (profilePictureUrl) {
          profileImageElement.src = `${profilePictureUrl}`;
          profileImageElement.style.display = 'block';
          console.log('Profile picture displayed:', profilePictureUrl);
        } else {
          profileImageElement.style.display = 'none';
          console.log('No profile picture found, hiding element');
        }
      } else {
        console.error('Profile image element not found in the DOM');
      }
    }

    // Call this function when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded');
      displayProfilePicture();
    });

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('authToken');
      if (token) {
        // User is logged in, fetch notifications
        fetchFriendRequests();
      }
    });

    async function loadFriendsList() {
      const token = localStorage.getItem('authToken');
      const friendsListModalContainer = document.getElementById('friendsListModalContainer');

      if (!friendsListModalContainer) {
        console.error('Friends list container not found');
        return;
      }

      try {
        const response = await fetch('http://localhost:5000/users/friends', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) {
          throw new Error('Failed to fetch friends');
        }

        const friends = await response.json();

        // Clear the container
        friendsListModalContainer.innerHTML = '';

        if (friends.length > 0) {
          friends.forEach((friend) => {
            console.log('Friend:', friend);
            // Create friend row container
            const friendRow = document.createElement('div');
            friendRow.classList.add('friend-row');

            // Create the profile picture element
            const profilePicture = document.createElement('img');
            profilePicture.classList.add('profile-picture');
            if (friend.profilePicture && friend.profilePicture !== '/uploads/profile-pictures/profileplaceholder.png') {
              profilePicture.src = `http://localhost:5000/uploads/profile-pictures/${friend.profilePicture}`;
            } else {
              // If there's no valid profile picture, use the placeholder
              profilePicture.src = `http://localhost:5000/uploads/profile-pictures/profileplaceholder.png`;
            }

            profilePicture.alt = `${friend.username}'s profile picture`;
            console.log(friend.profilePicture);
            // Create username element
            const usernameSpan = document.createElement('span');
            usernameSpan.classList.add('username');
            usernameSpan.textContent = friend.username;

            // Create the user info container (wrap profile picture and username)
            const userInfoDiv = document.createElement('div');
            userInfoDiv.classList.add('user-info');
            userInfoDiv.appendChild(profilePicture);
            userInfoDiv.appendChild(usernameSpan);

            const statusIndicator = document.createElement('div');
            statusIndicator.classList.add('status-indicator');
            statusIndicator.style.backgroundColor = friend.isOnline ? 'green' : 'red';
            statusIndicator.title = friend.isOnline ? 'Online' : 'Offline';
            // Create buttons container
            const buttonsDiv = document.createElement('div');
            buttonsDiv.classList.add('buttons');

            // Create the chat button
            const chatButton = document.createElement('button');
            chatButton.classList.add('fas', 'fa-comment');
            chatButton.classList.add('chatButton');
            chatButton.title = 'Chat';
            
            // Add click event listener with error handling
            chatButton.addEventListener('click', () => {
              console.log('Chat button clicked for:', friend.username);
              try {
                openChat(friend.username);
              } catch (error) {
                console.error('Error opening chat:', error);
              }
            });

            // Create the unfriend button
            const unfriendButton = document.createElement('button');
            unfriendButton.classList.add('unfriend-button');
            unfriendButton.classList.add('fa', 'fa-remove');
            unfriendButton.title = 'Remove friend';
            unfriendButton.addEventListener('click', () => {
              unfriendFriend(friend);
            });

            // Append elements to the row
            buttonsDiv.appendChild(statusIndicator);
            buttonsDiv.appendChild(chatButton);
            buttonsDiv.appendChild(unfriendButton);
            friendRow.appendChild(userInfoDiv); // Add user info (profile picture and username)
            friendRow.appendChild(buttonsDiv);

            // Add the row to the container
            friendsListModalContainer.appendChild(friendRow);
          });
        } else {
          friendsListModalContainer.innerHTML = '<p style="color: white;">No friends found</p>';
        }
      } catch (error) {
        console.error('Error loading friends list:', error);
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      loadFriendsList(); // Call your function here
    });

    // Update the openChat function to load chat history
    async function openChat(username) {
        console.log('Opening chat for:', username);
        const chatModal = document.getElementById('chatModal');
        const chatUsername = document.querySelector('.chat-username');
        const chatMessages = document.querySelector('.chat-messages');
        const chatProfilePicture = document.querySelector('.chat-profile-picture');
        
        if (!chatModal || !chatUsername || !chatMessages) {
            console.error('Chat modal elements not found');
            return;
        }
        
        currentChatPartner = username;
        chatUsername.textContent = username;
        chatMessages.innerHTML = '';
        
        // Update profile picture
        if (chatProfilePicture) {
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch('http://localhost:5000/users/friends', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const friends = await response.json();
                    const friend = friends.find(f => f.username === username);
                    if (friend && friend.profilePicture && friend.profilePicture !== '/uploads/profile-pictures/profileplaceholder.png') {
                        chatProfilePicture.src = `http://localhost:5000/uploads/profile-pictures/${friend.profilePicture}`;
                    } else {
                        chatProfilePicture.src = `http://localhost:5000/uploads/profile-pictures/profileplaceholder.png`;
                    }
                }
            } catch (error) {
                console.error('Error loading friend profile picture:', error);
                chatProfilePicture.src = `http://localhost:5000/uploads/profile-pictures/profileplaceholder.png`;
            }
        }
        
        // Load chat history
        try {
            const token = localStorage.getItem('authToken');
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedToken = JSON.parse(atob(base64));
            const currentUsername = decodedToken.username;

            const response = await fetch('http://localhost:5000/messages/history', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user1: currentUsername,
                    user2: username
                })
            });

            if (response.ok) {
                const messages = await response.json();
                messages.forEach(msg => {
                    const messageType = msg.from === currentUsername ? 'sent' : 'received';
                    displayMessage(msg.content, messageType);
                });
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
        
        chatModal.style.display = 'block';
    }

    function displayMessage(message, type) {
      const chatMessages = document.querySelector('.chat-messages');
      const messageElement = document.createElement('div');
      messageElement.classList.add('chat-message', `message-${type}`);
      messageElement.textContent = message;
      chatMessages.appendChild(messageElement);
      
      // Scroll to bottom
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById('chatInput');
      if (!input) return;

      const message = input.value.trim();
      
      if (message && socket && currentChatPartner) {
        // Get current user's username from token
        const token = localStorage.getItem('authToken');
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const decodedToken = JSON.parse(atob(base64));
        const currentUsername = decodedToken.username;

        // Emit message to server
        socket.emit('private_message', {
          to: currentChatPartner,
          from: currentUsername,
          message: message
        });

        // Display message in sender's chat
        displayMessage(message, 'sent');
        
        // Clear input after sending
        input.value = '';
      }
    }

    // Update your existing event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const closeChat = document.querySelector('.close-chat');
      if (closeChat) {
        closeChat.addEventListener('click', () => {
          const chatModal = document.getElementById('chatModal');
          if (chatModal) {
            chatModal.style.display = 'none';
            currentChatPartner = null;
          }
        });
      }

      const sendButton = document.getElementById('sendMessage');
      const chatInput = document.getElementById('chatInput');

      if (sendButton && chatInput) {
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            sendMessage();
          }
        });
      }
    });

    // Add to your login success handler
    async function handleLoginSuccess(token) {
      localStorage.setItem('authToken', token);
      // ... your existing login success code ...
      initializeSocket(); // Add this line
    }

    // Add this function to show/hide a loading indicator
    function setLoadingState(isLoading) {
        const chatMessages = document.querySelector('.chat-messages');
        if (isLoading) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'chat-loading';
            loadingDiv.textContent = 'Loading messages...';
            loadingDiv.style.textAlign = 'center';
            loadingDiv.style.padding = '10px';
            loadingDiv.style.color = '#aaaaaa';
            chatMessages.appendChild(loadingDiv);
        } else {
            const loadingDiv = document.getElementById('chat-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
    }

    let socket;
    let currentChatPartner;

    // Initialize socket when user logs in
    function initializeSocket() {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const decodedToken = JSON.parse(atob(base64));
        const currentUsername = decodedToken.username;

        socket = io('http://localhost:5000');
        socket.emit('user_connected', currentUsername);

        socket.on('private_message', ({ from, message }) => {
            if (from === currentChatPartner) {
                displayMessage(message, 'received');
            }
        });
    }

    function displayMessage(message, type) {
        const chatMessages = document.querySelector('.chat-messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message', `message-${type}`);
        messageElement.textContent = message;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        if (!input) return;

        const message = input.value.trim();
        
        if (message && currentChatPartner) {
            const token = localStorage.getItem('authToken');
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const decodedToken = JSON.parse(atob(base64));
            const currentUsername = decodedToken.username;

            socket.emit('private_message', {
                to: currentChatPartner,
                from: currentUsername,
                message: message
            });

            displayMessage(message, 'sent');
            input.value = '';
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('authToken')) {
            initializeSocket();
        }

        const closeChat = document.querySelector('.close-chat');
        if (closeChat) {
            closeChat.addEventListener('click', () => {
                const chatModal = document.getElementById('chatModal');
                if (chatModal) {
                    chatModal.style.display = 'none';
                    currentChatPartner = null;
                }
            });
        }

        const sendButton = document.getElementById('sendMessage');
        const chatInput = document.getElementById('chatInput');

        if (sendButton && chatInput) {
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
    });

    // Add this after your existing chat-related code
    function makeDraggable() {
        const chatModal = document.getElementById('chatModal');
        const dragHandle = document.getElementById('chatDragHandle');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        dragHandle.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);

        function dragStart(e) {
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;

            if (e.target === dragHandle || dragHandle.contains(e.target)) {
                isDragging = true;
                dragHandle.style.cursor = 'grabbing';
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                setTranslate(currentX, currentY, chatModal);
            }
        }

        function dragEnd() {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
            dragHandle.style.cursor = 'grab';
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate(${xPos}px, ${yPos}px)`;
        }
    }

    // Call this when the chat modal is opened
    document.addEventListener('DOMContentLoaded', () => {
        makeDraggable();
    });

  </script>

  <!-- Chat Modal -->
  <div id="chatModal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header" id="chatDragHandle">
        <div class="user-info">
          <img class="chat-profile-picture" src="http://localhost:5000/uploads/profile-pictures/profileplaceholder.png">
          <span class="chat-username"></span>
        </div>
        <span class="close-chat">&times;</span>
      </div>
      <div class="chat-messages"></div>
      <div class="chat-input-container">
        <input type="text" id="chatInput" placeholder="Type a message...">
        <button id="sendMessage"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

</body>

</html>